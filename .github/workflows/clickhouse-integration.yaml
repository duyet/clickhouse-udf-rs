name: clickhouse-integration

on:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  integration-test:
    name: ClickHouse ${{ matrix.clickhouse_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        clickhouse_version:
          - "25.6"
          - "25.7"
          - "25.8"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build all UDF binaries
        run: cargo build --release

      - name: List built binaries
        run: |
          echo "Built binaries:"
          ls -lh target/release/ | grep -E '^-.*x' | grep -v '\.d$'

      - name: Prepare ClickHouse directories
        run: |
          # Create directories for mounting
          mkdir -p ${{ github.workspace }}/clickhouse-data/user_scripts
          mkdir -p ${{ github.workspace }}/clickhouse-data/config

          # Copy UDF binaries
          echo "Copying UDF binaries..."
          cp target/release/read-wkt-linestring \
             target/release/vin-cleaner \
             target/release/vin-manuf \
             target/release/vin-year \
             target/release/extract-url \
             target/release/has-url \
             target/release/array-topk \
             target/release/extract-phone \
             target/release/tiktoken-count \
             target/release/tiktoken-encode \
             ${{ github.workspace }}/clickhouse-data/user_scripts/ 2>/dev/null || echo "Some binaries not found, continuing..."

          # Make binaries executable
          chmod +x ${{ github.workspace }}/clickhouse-data/user_scripts/*

          # Copy XML configurations
          echo "Copying XML configurations..."
          cp integration-tests/config/*.xml ${{ github.workspace }}/clickhouse-data/config/

          echo "Directory contents:"
          ls -la ${{ github.workspace }}/clickhouse-data/user_scripts/
          ls -la ${{ github.workspace }}/clickhouse-data/config/

      - name: Start ClickHouse container
        run: |
          echo "Starting ClickHouse ${{ matrix.clickhouse_version }}..."
          docker run -d \
            --name clickhouse-test \
            -p 8123:8123 \
            -p 9000:9000 \
            -v ${{ github.workspace }}/clickhouse-data/user_scripts:/var/lib/clickhouse/user_scripts \
            -v ${{ github.workspace }}/clickhouse-data/config:/etc/clickhouse-server/conf.d \
            ghcr.io/duyet/docker-images:clickhouse_${{ matrix.clickhouse_version }}

          echo "Container started, waiting for initialization..."
          sleep 5

      - name: Wait for ClickHouse to be ready
        run: |
          echo "Waiting for ClickHouse to be ready..."
          for i in {1..30}; do
            if docker exec clickhouse-test clickhouse-client --query "SELECT 1" > /dev/null 2>&1; then
              echo "âœ“ ClickHouse is ready!"
              echo ""
              echo "Version:"
              docker exec clickhouse-test clickhouse-client --query "SELECT version()"
              echo ""

              echo "Checking mounted directories..."
              docker exec clickhouse-test ls -la /var/lib/clickhouse/user_scripts/
              echo ""
              docker exec clickhouse-test ls -la /etc/clickhouse-server/conf.d/
              echo ""

              echo "Reloading configuration..."
              docker exec clickhouse-test clickhouse-client --query "SYSTEM RELOAD CONFIG" || true

              echo "Waiting 5 seconds for functions to load..."
              sleep 5

              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 3
          done

          echo "ERROR: ClickHouse did not become ready in time"
          echo "Container logs:"
          docker logs clickhouse-test 2>&1 | tail -100
          exit 1

      - name: Verify UDF registration
        run: |
          echo "=== Checking UDF Registration ==="
          echo ""

          echo "All custom functions:"
          docker exec clickhouse-test clickhouse-client --query "SELECT name FROM system.functions WHERE origin = 'Executable' ORDER BY name" || echo "No executable functions found"

          echo ""
          echo "Expected UDFs (searching by name):"
          docker exec clickhouse-test clickhouse-client --query "SELECT name FROM system.functions WHERE name IN ('readWktLineString', 'vinCleaner', 'vinManuf', 'vinYear', 'extractUrl', 'hasUrl', 'arrayTopK', 'extractPhone', 'tiktokenCount', 'tiktokenEncode') ORDER BY name"

          echo ""
          echo "If functions are missing, checking ClickHouse logs for errors:"
          docker logs clickhouse-test 2>&1 | grep -i "executable\|user_scripts\|function" | tail -20 || echo "No relevant log entries"

      - name: Run integration tests
        run: |
          cd integration-tests
          ./run-tests.sh

      - name: Add test summary to job
        if: always()
        run: |
          if [ -f integration-tests/test-summary.md ]; then
            echo "## ClickHouse ${{ matrix.clickhouse_version }}" >> $GITHUB_STEP_SUMMARY
            cat integration-tests/test-summary.md >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-${{ matrix.clickhouse_version }}
          path: integration-tests/test-summary.md
          retention-days: 30

      - name: Show ClickHouse logs on failure
        if: failure()
        run: |
          echo "=== ClickHouse server logs ==="
          docker logs clickhouse-test 2>&1 | tail -100

      - name: Debug - List ClickHouse directories
        if: failure()
        run: |
          echo "=== Contents of /var/lib/clickhouse/user_scripts/ ==="
          docker exec clickhouse-test ls -la /var/lib/clickhouse/user_scripts/ || true

          echo ""
          echo "=== Contents of /etc/clickhouse-server/conf.d/ ==="
          docker exec clickhouse-test ls -la /etc/clickhouse-server/conf.d/ || true

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping and removing container..."
          docker stop clickhouse-test || true
          docker rm clickhouse-test || true

  post-pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: integration-test
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Download all test summaries
        uses: actions/download-artifact@v4
        with:
          pattern: test-summary-*
          path: summaries

      - name: Create consolidated report
        env:
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Debug: List downloaded artifacts
          echo "=== Downloaded Artifacts ==="
          ls -la summaries/ || echo "No summaries directory found"
          find summaries/ -name "*.md" -exec echo "Found: {}" \; 2>/dev/null || echo "No markdown files found"
          echo ""

          # Header with metadata (compact)
          cat > pr-comment.md <<EOF
          ## ðŸ§ª ClickHouse Integration Tests

          [Workflow #${{ github.run_number }}]($WORKFLOW_URL) â€¢ [\`${COMMIT_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/$COMMIT_SHA) â€¢ @${{ github.actor }}

          EOF

          # Count total pass/fail across all versions
          total_passed=0
          total_failed=0
          total_tests=0
          tested_versions=0

          # Add results for each version
          for dir in summaries/test-summary-*; do
            if [ -d "$dir" ] && [ -f "$dir/test-summary.md" ]; then
              tested_versions=$((tested_versions + 1))

              # Extract version from directory name
              version=$(basename "$dir" | sed 's/test-summary-//')

              echo "Processing version: $version"
              echo "File: $dir/test-summary.md"

              # Add compact version in collapsible section
              echo "<details>" >> pr-comment.md
              echo "<summary><strong>ClickHouse $version</strong> - [View Logs]($WORKFLOW_URL)</summary>" >> pr-comment.md
              echo "" >> pr-comment.md

              # Add the detailed summary
              tail -n +2 "$dir/test-summary.md" >> pr-comment.md
              echo "" >> pr-comment.md
              echo "</details>" >> pr-comment.md
              echo "" >> pr-comment.md

              # Extract metrics for overall summary (using more robust patterns)
              # Look for the metrics in the table format
              if grep -q "Passed" "$dir/test-summary.md"; then
                echo "Extracting metrics from $dir/test-summary.md"
                cat "$dir/test-summary.md"

                # Try different patterns to extract the numbers
                passed=$(grep "Passed" "$dir/test-summary.md" | grep -oE '\`[0-9]+\`' | head -1 | tr -d '`' || echo "0")
                failed=$(grep "Failed" "$dir/test-summary.md" | grep -oE '\`[0-9]+\`' | head -1 | tr -d '`' || echo "0")
                tests=$(grep "Total Tests" "$dir/test-summary.md" | grep -oE '\`[0-9]+\`' | head -1 | tr -d '`' || echo "0")

                echo "Extracted: tests=$tests, passed=$passed, failed=$failed"

                total_passed=$((total_passed + passed))
                total_failed=$((total_failed + failed))
                total_tests=$((total_tests + tests))
              fi
            fi
          done

          echo "=== Final Totals ==="
          echo "Versions: $tested_versions"
          echo "Total Tests: $total_tests"
          echo "Passed: $total_passed"
          echo "Failed: $total_failed"

          # Overall summary (compact)
          if [ $tested_versions -gt 0 ] && [ $total_tests -gt 0 ]; then
            success_rate=$(awk "BEGIN {printf \"%.1f\", ($total_passed/$total_tests)*100}")

            # Determine status emoji
            if [ $total_failed -eq 0 ]; then
              status="âœ… All tests passed"
            else
              status="âŒ $total_failed test(s) failed"
            fi

            cat >> pr-comment.md <<EOF
          ### Summary: $status

          **$tested_versions** ClickHouse versions tested â€¢ **$total_tests** tests â€¢ **$success_rate%** success rate

          EOF
          elif [ $tested_versions -gt 0 ] && [ $total_tests -eq 0 ]; then
            cat >> pr-comment.md <<EOF
          ### âš ï¸ No test results extracted

          Test summaries were found but metrics could not be parsed. [Check logs]($WORKFLOW_URL).

          EOF
          else
            cat >> pr-comment.md <<EOF
          ### âš ï¸ No test summaries found

          Integration tests may not have run successfully. [Check logs]($WORKFLOW_URL).

          EOF
          fi

          # Compact footer
          cat >> pr-comment.md <<EOF

          <sub>ðŸ¤– Tested: CH 25.6, 25.7, 25.8 â€¢ UDFs: wkt, vin, url, array, string, tiktoken â€¢ [View Workflow](https://github.com/${{ github.repository }}/blob/main/.github/workflows/clickhouse-integration.yaml)</sub>
          EOF

          echo "=== Generated PR Comment ==="
          cat pr-comment.md

      - name: Post comment to PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: pr-comment.md
          edit-mode: replace
