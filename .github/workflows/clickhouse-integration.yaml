name: clickhouse-integration

on:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  integration-test:
    name: ClickHouse ${{ matrix.clickhouse_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        clickhouse_version:
          - "25.6"
          - "25.7"
          - "25.8"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build all UDF binaries
        run: cargo build --release

      - name: List built binaries
        run: |
          echo "Built binaries:"
          ls -lh target/release/ | grep -E '^-.*x' | grep -v '\.d$'

      - name: Prepare ClickHouse directories
        run: |
          # Create directories for mounting
          mkdir -p ${{ github.workspace }}/clickhouse-data/user_scripts
          mkdir -p ${{ github.workspace }}/clickhouse-data/config

          # Copy UDF binaries
          echo "Copying UDF binaries..."
          cp target/release/read-wkt-linestring \
             target/release/vin-cleaner \
             target/release/vin-manuf \
             target/release/vin-year \
             target/release/extract-url \
             target/release/has-url \
             target/release/array-topk \
             target/release/extract-phone \
             target/release/tiktoken-count \
             target/release/tiktoken-encode \
             ${{ github.workspace }}/clickhouse-data/user_scripts/ 2>/dev/null || echo "Some binaries not found, continuing..."

          # Make binaries executable
          chmod +x ${{ github.workspace }}/clickhouse-data/user_scripts/*

          # Copy XML configurations
          echo "Copying XML configurations..."
          cp integration-tests/config/*.xml ${{ github.workspace }}/clickhouse-data/config/

          echo "Directory contents:"
          ls -la ${{ github.workspace }}/clickhouse-data/user_scripts/
          ls -la ${{ github.workspace }}/clickhouse-data/config/

      - name: Start ClickHouse container
        run: |
          echo "Starting ClickHouse ${{ matrix.clickhouse_version }}..."
          docker run -d \
            --name clickhouse-test \
            -p 8123:8123 \
            -p 9000:9000 \
            -v ${{ github.workspace }}/clickhouse-data/user_scripts:/var/lib/clickhouse/user_scripts \
            -v ${{ github.workspace }}/clickhouse-data/config:/etc/clickhouse-server/conf.d \
            ghcr.io/duyet/docker-images:clickhouse_${{ matrix.clickhouse_version }}

          echo "Container started, waiting for initialization..."
          sleep 5

      - name: Wait for ClickHouse to be ready
        run: |
          echo "Waiting for ClickHouse to be ready..."
          for i in {1..30}; do
            if docker exec clickhouse-test clickhouse-client --query "SELECT 1" > /dev/null 2>&1; then
              echo "âœ“ ClickHouse is ready!"
              echo ""
              echo "Version:"
              docker exec clickhouse-test clickhouse-client --query "SELECT version()"
              echo ""
              echo "Reloading configuration..."
              docker exec clickhouse-test clickhouse-client --query "SYSTEM RELOAD CONFIG" || true
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 3
          done

          echo "ERROR: ClickHouse did not become ready in time"
          echo "Container logs:"
          docker logs clickhouse-test 2>&1 | tail -100
          exit 1

      - name: Verify UDF registration
        run: |
          echo "Checking registered UDF functions..."
          docker exec clickhouse-test clickhouse-client --query "SELECT name FROM system.functions WHERE name LIKE '%vin%' OR name LIKE '%array%' OR name LIKE '%wkt%' OR name LIKE '%url%' OR name LIKE '%tiktoken%' OR name LIKE '%phone%' ORDER BY name"

      - name: Run integration tests
        run: |
          cd integration-tests
          ./run-tests.sh

      - name: Show ClickHouse logs on failure
        if: failure()
        run: |
          echo "=== ClickHouse server logs ==="
          docker logs clickhouse-test 2>&1 | tail -100

      - name: Debug - List ClickHouse directories
        if: failure()
        run: |
          echo "=== Contents of /var/lib/clickhouse/user_scripts/ ==="
          docker exec clickhouse-test ls -la /var/lib/clickhouse/user_scripts/ || true

          echo ""
          echo "=== Contents of /etc/clickhouse-server/conf.d/ ==="
          docker exec clickhouse-test ls -la /etc/clickhouse-server/conf.d/ || true

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping and removing container..."
          docker stop clickhouse-test || true
          docker rm clickhouse-test || true
